<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Import Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <!-- Import latest version (v5) of d3.js -->
    <script src='https://d3js.org/d3.v5.min.js'></script>

    <link rel="stylesheet" type="text/css" href="dashboard.css">
    <script type="text/javascript" src="load-data.js"></script>
    <script type="text/javascript" src="filter.js"></script>
    <script type="text/javascript" src="hbar-chart.js"></script>
    <script type="text/javascript" src="hist-chart.js"></script>
    <script type="text/javascript" src="donut-chart.js"></script>
    <script type="text/javascript" src="util.js"></script>
  </head>
  <body>
    <header>
      <nav class="navbar navbar-expand-sm bg-primary navbar-dark">
        <ul class="navbar-nav">
          <li class="nav-item active">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">Dashboard</a>
          </li>
        </ul>
      </nav>
    </header>
    <div id="loader-circle">
      <div class="loader-bar">
        <div class="loader-bar">
          <div class="loader-bar">
            <div class="loader-bar"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="wrapper">
      <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-brand">
            <span>Your dreamjob</span>
          </li>
          <li class='sidebar-selection'>
            <span href="#">Developer Type:</span>
            <button id="devtype-dropdown" class="btn dropdown-toggle btn-primary" type="button" data-toggle="dropdown">All
            <span class="caret"></span></button>
            <ul id="devtype-dropdown-menu" class="dropdown-menu"></ul>
          </li>
          <li class='sidebar-selection'>
            <span href="#">Company Size:</span>
            <button id="compsize-dropdown" class="btn dropdown-toggle btn-primary" type="button" data-toggle="dropdown">All
            <span class="caret"></span></button>
            <ul id="compsize-dropdown-menu" class="dropdown-menu"></ul>
          </li>
          <li class='sidebar-selection'>
            <span href="#">Country:</span>
            <button id="country-dropdown" class="btn dropdown-toggle btn-primary" type="button" data-toggle="dropdown">All
            <span class="caret"></span></button>
            <ul id="country-dropdown-menu" class="dropdown-menu"></ul>
          </li>
          <li class='sidebar-selection'>
            <span href="#">Employment:</span>
            <button id="employment-dropdown" class="btn dropdown-toggle btn-primary" type="button" data-toggle="dropdown">All
            <span class="caret"></span></button>
            <ul id="employment-dropdown-menu" class="dropdown-menu"></ul>
          </li>
          <li class='sidebar-selection'>
            <span href="#">Gender:</span>
            <button id="gender-dropdown" class="btn dropdown-toggle btn-primary" type="button" data-toggle="dropdown">All
            <span class="caret"></span></button>
            <ul id="gender-dropdown-menu" class="dropdown-menu"></ul>
          </li>
         </ul>
       </div>
       <div id="page-content-wrapper">
         <div class="row" style="height: 100%">
           <div class="col-lg-4">
             <div class="card text-center" style="height: 100%">
               <div class="card-header">Popular programming languages</div>
               <div class="card-body" id="popular-languages-container"></div>
             </div>
          </div>
          <div class="col-lg-8">
            <div class="row" style="height: 50%">
              <div class="col-lg-12">
                <div class="card text-center" style="height: 100%">
                  <div class="card-header">Salary</div>
                  <div class="card-body"></div>
                </div>
              </div>
            </div>
            <div class="row" style="height: 50%">
              <div class="col-lg-6">
                <div class="card text-center" style="height: 100%">
                  <div class="card-header">Day distribution</div>
                  <div class="card-body"></div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="card text-center" style="height: 100%">
                  <div class="card-header">Job satisfaction</div>
                  <div class="card-body" id="job-satisfaction-container"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    const fillSelectionMenus = (menuMappings) => {
      Object.keys(menuMappings).forEach((key) => {
        const selectionMenu = document.getElementById(key);
        selectionMenu.innerHTML += '<li onclick="onSelected(\'All\', \'' + menuMappings[key]['column'] + '\', \'' + key + '\')"><div>All</div></li>';
        menuMappings[key]['data'].forEach((value) => {
          selectionMenu.innerHTML += '<li onclick="onSelected(\'' + value + '\', \'' + menuMappings[key]['column'] + '\', \'' + key + '\')"><div>' + value + '</div></li>';
        })
      });
    };

    const onSelected = (selectedValue, subject, dropdownId) => {
      document.getElementById(dropdownId.split('-').slice(0, 2).join('-')).innerText = selectedValue;
      if (selectedValue == 'All') {
        filter.remove(subject);
      } else {
        const obj = {};
        obj[subject] = selectedValue;
        filter.merge(obj);
      }
      filter.apply();
    };

    const updateDashboardTitle = (value) => {
      const title = document.getElementById("dashboard-title");
      title.innerText = 'Results of ' + value + ' software developers';
    };

    const updateAvgSalary = (value) => {
      const info = document.getElementById("hist-info");
      info.innerText = 'Average salary: $' + Math.round(value);
    };

    const toggleSpinner = (on_load_id='loader-circle', load_done_id='wrapper') => {
       const spinner = document.getElementById(on_load_id);
       const content = document.getElementById(load_done_id);
       if (spinner.style.display == 'block' && content.style.display == 'none') {
         spinner.style.display = 'none';
         content.style.display = 'block';
       } else {
         spinner.style.display = 'block';
         content.style.display = 'none';
       }
    };

    const plotPopularLanguages = (data, container) => {
      let groupedData = sortGroups(groupBy(data, 'LanguageWorkedWith', (value) => value / data.length));
      const hbar = new Hbar({
        width: 350,
        height: 520,
        margin: { top: 0, right: 60, bottom: 0, left: 80 },
        padding: 0.1,
        limit: 30,
        fontSize: '1em',
        labelAnchor: 1.2
      });
      hbar.plot(groupedData, container);
      // On data update
      filter.onFilterApplied(data => {
        hbar.updateData(sortGroups(groupBy(data, 'LanguageWorkedWith', (value) => value / data.length)));
      });
    };

    const plotJobSatisfaction = (data, container) => {
      let groupedData = sortJobSatisfaction(groupBy(data, 'JobSatisfaction', (value) => value / data.length));
      const hbar = new Hbar({
        width: 250,
        height: 225,
        margin: { top: 0, right: 60, bottom: 0, left: 175 },
        padding: 0.1,
        fontSize: '1em',
        labelAnchor: 1.2
      });
      hbar.plot(groupedData, container);
      // On data update
      filter.onFilterApplied(data => {
        hbar.updateData(sortJobSatisfaction(groupBy(data, 'JobSatisfaction', (value) => value / data.length)));
      });
    };

    const plotSalary = (data, container) => {

    };

    toggleSpinner();
    loadData('./dataset/2018 Stack Overflow Survey Results_prepped.csv').then(data => {
      toggleSpinner();
      const sortAscFunc = (a, b) => a.localeCompare(b);
      fillSelectionMenus({
        'devtype-dropdown-menu': {
          data: uniques(data, 'DevType').sort(sortAscFunc),
          column: 'DevType'
        },
        'compsize-dropdown-menu': {
          data: uniques(data, 'CompanySize').sort(sortAscFunc),
          column: 'CompanySize'
        },
        'country-dropdown-menu': {
          data: uniques(data, 'Country').sort(sortAscFunc),
          column: 'Country'
        },
        'employment-dropdown-menu': {
          data: uniques(data, 'Employment').sort(sortAscFunc),
          column: 'Employment'
        },
        'gender-dropdown-menu': {
          data: uniques(data, 'Gender').sort(sortAscFunc),
          column: 'Gender'
        },
      })
      filter = new Filter(data);
      filter.apply();
      // plotPopularLanguages(data, '#popular-languages-container');
      // plotJobSatisfaction(data, '#job-satisfaction-container')

      /**
      updateDashboardTitle(data.length);

      // Plot histogram
      const hist = new Hist(d3);
      const histOptions = {
        container: '#hist-chart-container',
        width: 950,
        height: 225,
        margin: { top: 20, right: 30, bottom: 20, left: 40 },
        padding: 0.1,
        bins: 20,
        max: 200000,
        min: 0
      }

      let histData = values(data, 'ConvertedSalary');
      updateAvgSalary(avg(histData));
      hist.plot(histData, histOptions);



      // Plot donut chart
      const donut = new Donut();
      const avgComputerHours = avg(values(data, 'HoursComputer'));
      const avgOutsideHours = avg(values(data, 'HoursOutside'));
      const donutData = [{ key: 'computer time', value: avgComputerHours / 24, color: '#3D33FB'},
                         { key: 'outside time', value: avgOutsideHours / 24, color: '#635BFB' },
                         { key: 'other', value: (24 - avgComputerHours - avgOutsideHours) / 24, color: '#B1ADFD' }];
     const donutOptions = {
       container: '#day-chart-container',
       width: 250,
       height: 250,
       margin: { top: 0, right: 0, bottom: 0, left: 0 },
       padding: 0.1,
       radius: 100
     }
     donut.plot(donutData, donutOptions);

      filter.onFilterApplied(data => {
        updateDashboardTitle(data.length);
        const histValues = values(data, 'ConvertedSalary');
        updateAvgSalary(avg(histValues));
        hist.updateData(histValues);
        // hbar2.updateData(sortGroups(groupBy(data, 'JobSatisfaction', (value) => {
        //   return value / data.length;
        // }), true))
        // const avgComputerHours = avg(values(data, 'HoursComputer'));
        // const avgOutsideHours = avg(values(data, 'HoursOutside'));
        // const donutData = [{ key: 'computer time', value: avgComputerHours / 24, color: '#3D33FB'},
        //                    { key: 'outside time', value: avgOutsideHours / 24, color: '#635BFB' },
        //                    { key: 'other', value: (24 - avgComputerHours - avgOutsideHours) / 24, color: '#B1ADFD' }];
        // donut.plot(donutData, donutOptions);
      });
          **/
    });
    <!-- Menu Toggle Script -->
     $("#menu-toggle").click(function(e) {
         e.preventDefault();
         $("#wrapper").toggleClass("toggled");
     });
  </script>
</html>
