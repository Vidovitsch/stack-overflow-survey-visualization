<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Import Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <!-- Import latest version (v5) of d3.js -->
    <script src='https://d3js.org/d3.v5.min.js'></script>

    <link rel="stylesheet" type="text/css" href="index.css">
    <script type="text/javascript" src="load-data.js"></script>
    <script type="text/javascript" src="filter.js"></script>
    <script type="text/javascript" src="hbar-chart.js"></script>
  </head>
  <body>
<div class="barchart"></div>
  </body>
  <script>
    //https://d3js.org/d3.v3.min.js

    var data1 =  [ {'key':'Protein', 'value': 25},{'key':'Carbs', 'value': 50},{'key':'Sodium', 'value': 75}, {'key':'Fat', 'value': 100} ];

    // var width = d3.select('.barchart').style('width').replace("\px","") - 100
    var width = d3.select('.barchart').node().clientWidth - 100;
    var height = d3.select('.barchart').node().clientHeight;
    var svgWidth = width + 100

    // SCALES
    var colorScale = d3.scaleOrdinal()
      .domain(data1.map(function(d) { return d.key}))
      //.range(['pink','lightblue','lightgreen','yellow'])

    var colorScale2 = d3.scaleLinear()
      .domain([0, data1.length-1])
      //.range(['lightblue','lightgreen'])

    var xScale = d3.scaleLinear()
      .domain([0,100])
      .range([0,width])
    var yScale = d3.scaleBand()
      .range([height, 0])
      .domain(data1.map(function(d) { return d.key; }))
      .padding(0.1);

    // SVG
    var svg = d3.select('.barchart')
      .append('svg')
        .attr("width",svgWidth)
        .attr('height',height)//.style('border','1px solid')

    var tooltip = d3.select("body")
      .append("div")
      .attr("class", "toolTip");
    // CHART AREA
    var vals = svg.append('g')
      .attr('transform','translate(100,0)' )
      .attr('width',width - 60)
      .attr("height",height)

    function update(data) {
      // DATA BIND
      var chart = vals.selectAll('rect').data(data)
      // ENTER
      chart.enter().append('rect')
        .attr("width",function(d) { return xScale(d.value) } )
        .attr("height", yScale.bandwidth())
        .attr('x',0).attr('y', function(d,i) { return yScale(d.key)} )
        .attr("fill", function(d,i) { return colorScale2(i)})
        //.attr("fill", function(d,i) { return colorScale(d.key)})
      // UPDATE
      chart.transition().duration(1000).attr("width",function(d) { return xScale(d.value) })

      // DATA BIND
      var key = vals.selectAll('text.key').data(data)
      // ENTER
      key.enter().append("text").attr("class","key")
      .attr("x", -45)
      .attr("y", function(d,i) {  return yScale(d.key) } )
      .attr('dy',30)
      .attr("text-anchor", "end")
      .text(function(d) { return d.key })

      // UPDATE
      key.text(function(d) { return d.key })
      // DATA BIND
      var percent = vals.selectAll('text.percent').data(data)
      // ENTER
      percent.enter().append("text").attr("class","percent")
        	.attr("x", -5).attr("y", function(d,i) {  return yScale(d.key)  } )
          .attr('dy',30)
          .attr("text-anchor", "end")
          .text(d => d.value + "%")
          // .text('0 %')
      // UPDATE
      percent.transition().duration(1000)
          .tween("text", function(d) {
             var that = d3.select(this)
             debugger;
             var content = that.text().replace('\%',"" )
             var i = d3.interpolateRound(content, d.value);
             return function( t ) {
                that.text(i(t) + '% ')
            };
           });

       chart.on("mousemove", function(d){
          tooltip
            .style("left", d3.event.pageX - 50 + "px")
            .style("top", d3.event.pageY - 70 + "px")
            .style("display", "inline-block")
            .html((d.key) + "<br>" + (d.value));
      })
      chart.on("mouseout", function(d){ tooltip.style("display", "none");})
    }

    update(data1)
    setInterval(function() {
      update(randomize())
    },3000)

    function randomize(){
      function random() {
        return Math.floor( Math.random() * 100)
      }
      var data =  [ {'key':'Protein', 'value': random() },{'key':'Carbs', 'value': random()},{'key':'Sodium', 'value': random()}, {'key':'Fat', 'value': 100} ];
      return data
    }

    // function tween(d) {
    //    console.log(this.textContent, d.value)
    //    var currentVal = +this.textContent
    //    var i = d3.interpolateRound(currentVal, d.value);
    //   return function( t ) {
    //      this.textContent = i( t ) + '%';
    //   };
    // };

    // function percentCal(a){
    //   var result = Math.ceil((a / 100) * 100) ; console.log(result)
    //   return result
    // }``

  </script>
</html>
