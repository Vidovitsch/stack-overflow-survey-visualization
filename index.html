<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Import Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <!-- Import latest version (v5) of d3.js -->
    <script src='https://d3js.org/d3.v5.min.js'></script>

    <link rel="stylesheet" type="text/css" href="index.css">
    <script type="text/javascript" src="load-data.js"></script>
    <script type="text/javascript" src="filter.js"></script>
    <script type="text/javascript" src="hbar-chart.js"></script>
  </head>
  <body>
    <header></header>

    <div id="circle">
      <div class="loader">
        <div class="loader">
          <div class="loader">
            <div class="loader"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="container">
      <div class="dropdown-bar">
        <div class="dropdown">
          <button id="jobtype-dropdown" class="btn dropdown-toggle btn-primary" type="button" data-toggle="dropdown">Job Types
            <span class="caret"></span></button>
          <ul id="jobtype-dropdown-menu" class="dropdown-menu"></ul>
        </div>
        <div class="dropdown">
          <button id="companysize-dropdown" class="btn dropdown-toggle btn-primary" type="button" data-toggle="dropdown">Company Size
            <span class="caret"></span></button>
          <ul id="companysize-dropdown-menu" class="dropdown-menu"></ul>
        </div>
        <div class="dropdown">
          <button id="country-dropdown" class="btn dropdown-toggle btn-primary" type="button" data-toggle="dropdown">Country
            <span class="caret"></span></button>
          <ul id="country-dropdown-menu" class="dropdown-menu"></ul>
        </div>
        <div class="dropdown">
          <button id="employment-dropdown" class="btn dropdown-toggle btn-primary" type="button" data-toggle="dropdown">Employment
            <span class="caret"></span></button>
          <ul id="employment-dropdown-menu" class="dropdown-menu"></ul>
        </div>
        <div class="dropdown">
          <button id="gender-dropdown" class="btn dropdown-toggle btn-primary" type="button" data-toggle="dropdown">Gender
            <span class="caret"></span></button>
          <ul id="gender-dropdown-menu" class="dropdown-menu"></ul>
        </div>
    </div>
    <h2 id='dashboard-title'></h2>
  </div>
  </body>
  <script>
    let filter = {};

    const toggleSpinner = (on_load_id='circle', load_done_id='container') => {
       const spinner = document.getElementById(on_load_id);
       const content = document.getElementById(load_done_id);
       if (spinner.style.display == 'block' && content.style.display == 'none') {
         spinner.style.display = 'none';
         content.style.display = 'block';
       } else {
         spinner.style.display = 'block';
         content.style.display = 'none';
       }
    }

    const onSelected = (selectedValue, subject, dropdownId) => {
      document.getElementById(dropdownId).innerText = selectedValue;
      if (selectedValue == 'All') {
        filter.remove(subject);
      } else {
        const obj = {};
        obj[subject] = selectedValue;
        filter.merge(obj);
      }
      filter.apply();
    }

    const fillJobTypeSelection = (data, loader) => {
      const container = document.getElementById("jobtype-dropdown-menu");
      container.innerHTML += '<li onclick="onSelected(\'All\', \'DevType\', \'jobtype-dropdown\')"><div>All</div></li>';
      loader.getUniques(data, 'DevType').forEach((value) => {
        container.innerHTML += '<li onclick="onSelected(\'' + value + '\', \'DevType\', \'jobtype-dropdown\')"><div>' + value + '</div></li>';
      });
    }

    const fillCompanySizeSelection = (data, loader) => {
      const container = document.getElementById("companysize-dropdown-menu");
      container.innerHTML += '<li onclick="onSelected(\'All\', \'CompanySize\', \'companysize-dropdown\')"><div>All</div></li>';
      loader.getUniques(data, 'CompanySize').forEach((value) => {
        container.innerHTML += '<li onclick="onSelected(\'' + value + '\', \'CompanySize\', \'companysize-dropdown\')"><div>' + value + '</div></li>';
      });
    }

    const fillCountrySelection = (data, loader) => {
      const container = document.getElementById("country-dropdown-menu");
      container.innerHTML += '<li onclick="onSelected(\'All\', \'Country\', \'country-dropdown\')"><div>All</div></li>';
      loader.getUniques(data, 'Country').forEach((value) => {
        container.innerHTML += '<li onclick="onSelected(\'' + value + '\', \'Country\', \'country-dropdown\')"><div>' + value + '</div></li>';
      });
    }

    const fillEmploymentSelection = (data, loader) => {
      const container = document.getElementById("employment-dropdown-menu");
      container.innerHTML += '<li onclick="onSelected(\'All\', \'Employment\', \'employment-dropdown\')"><div>All</div></li>';
      loader.getUniques(data, 'Employment').forEach((value) => {
        container.innerHTML += '<li onclick="onSelected(\'' + value + '\', \'Employment\', \'employment-dropdown\')"><div>' + value + '</div></li>';
      });
    }

    const updateDashboardTitle = (value) => {
      const title = document.getElementById("dashboard-title");
      title.innerText = 'Results of ' + value + ' software developers';
    }

    const fillGenderSelection = (data, loader) => {
      const container = document.getElementById("gender-dropdown-menu");
      container.innerHTML += '<li onclick="onSelected(\'All\', \'Gender\', \'gender-dropdown\')"><div>All</div></li>';
      loader.getUniques(data, 'Gender').forEach((value) => {
        container.innerHTML += '<li onclick="onSelected(\'' + value + '\', \'Gender\', \'gender-dropdown\')"><div>' + value + '</div></li>';
      });
    }

    toggleSpinner();
    const loader = new DataLoader(d3);
    loader.loadData('./dataset/2018 Stack Overflow Survey Results_prepped.csv', loader.defaultMapper).then(function(data) {
      updateDashboardTitle(data.length);
      fillJobTypeSelection(data, loader);
      fillCompanySizeSelection(data, loader);
      fillCountrySelection(data, loader);
      fillEmploymentSelection(data, loader);
      fillGenderSelection(data, loader);

      filter = new Filter(data);
      filter.apply();

      const hbar = new Hbar(d3);
      const { ordinalData, total } = loader.toOrdinalData(data, 'LanguageWorkedWith');
      hbar.plot(ordinalData, {
        container: '#container',
        width: 450,
        height: 550,
        margin: { top: 0, right: 60, bottom: 0, left: 120 },
        padding: 0.1
      });

      filter.onFilterApplied(data => {
        const { ordinalData, total } = loader.toOrdinalData(data, 'LanguageWorkedWith');
        updateDashboardTitle(data.length);
        hbar.updateData(ordinalData);
      });

      toggleSpinner();
    });
  </script>
</html>
