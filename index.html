<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Import Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <!-- Import latest version (v5) of d3.js -->
    <script src='https://d3js.org/d3.v5.min.js'></script>

    <link rel="stylesheet" type="text/css" href="index.css">
    <script type="text/javascript" src="load-data.js"></script>
    <script type="text/javascript" src="filter.js"></script>
    <script type="text/javascript" src="hbar-chart.js"></script>
    <script type="text/javascript" src="hist-chart.js"></script>
    <script type="text/javascript" src="util.js"></script>
  </head>
  <body>
    <header></header>
    <div id="circle">
      <div class="loader">
        <div class="loader">
          <div class="loader">
            <div class="loader"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="container">
      <div id="dropdown-bar" class="dropdown-bar"></div>
      <h3 id="dashboard-title"></h3>
      <div id="dashboard">
        <div class="row">
          <div class="col-lg-4">
            <div class="card">
              <div id="hbar-chart-container" class="card-body"></div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="row">
              <div class="card">
                <div id="hist-chart-container" class="card-body"></div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-4">
              </div>
              <div class="col-lg-4">
              </div>
              <div class="col-lg-4">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    let filter = {};

    const createSelectionMenu = (data, containerId, dropdowns) => {
      const container = document.getElementById(containerId);
      Object.keys(dropdowns).forEach((key) => {
        // Create button with dropdown menu
        container.innerHTML +=
          '<div class="dropdown">' +
            '<button id="' + key + '-dropdown" class="btn dropdown-toggle btn-primary" type="button" ' +
              'data-toggle="dropdown">' + dropdowns[key] +
            '<span class="caret"></span></button>' +
            '<ul  id="' + key + '-dropdown-menu" class="dropdown-menu"></ul>' +
          '</div>';
        // Fill dropdown menu
        const menu = document.getElementById(key + '-dropdown-menu');
        menu.innerHTML += '<li onclick="onSelected(\'All\', \'' + dropdowns[key] + '\', \'' + key + '-dropdown\')"><div>All</div></li>';
        uniques(data, dropdowns[key]).sort((a, b) => {
          return a.localeCompare(b);
        }).forEach((value) => {
          menu.innerHTML += '<li onclick="onSelected(\'' + value + '\', \'' + dropdowns[key] + '\', \'' + key + '-dropdown\')"><div>' + value + '</div></li>';
        });
      });
    };

    const onSelected = (selectedValue, subject, dropdownId) => {
      document.getElementById(dropdownId).innerText = selectedValue;
      if (selectedValue == 'All') {
        filter.remove(subject);
      } else {
        const obj = {};
        obj[subject] = selectedValue;
        filter.merge(obj);
      }
      filter.apply();
    }

    const updateDashboardTitle = (value) => {
      const title = document.getElementById("dashboard-title");
      title.innerText = 'Results of ' + value + ' software developers';
    }

    const toggleSpinner = (on_load_id='circle', load_done_id='container') => {
       const spinner = document.getElementById(on_load_id);
       const content = document.getElementById(load_done_id);
       if (spinner.style.display == 'block' && content.style.display == 'none') {
         spinner.style.display = 'none';
         content.style.display = 'block';
       } else {
         spinner.style.display = 'block';
         content.style.display = 'none';
       }
    }

    toggleSpinner();
    loadData(d3, './dataset/2018 Stack Overflow Survey Results_prepped.csv').then(data => {
      createSelectionMenu(data, 'dropdown-bar', {
        jobtype: 'DevType',
        companysize: 'CompanySize',
        country: 'Country',
        employment: 'Employment',
        gender: 'Gender'
      });
      updateDashboardTitle(data.length);
      filter = new Filter(data);
      filter.apply();

      // Plot horizontal bar chart
      const hbar = new Hbar(d3);
      const hbarOptions = {
        container: '#hbar-chart-container',
        width: 350,
        height: 550,
        margin: { top: 0, right: 60, bottom: 0, left: 80 },
        padding: 0.1,
        maxLabels: 30,
        colors: ['#3D33FB', '#443BFB', '#4C43FB', '#544BFB', '#5C53FB',
          '#635BFB', '#6B63FB', '#736CFC', '#7B74FC', '#827CFC',
          '#8A84FC', '#928CFC', '#9A94FC', '#A19CFC', '#A9A5FD',
          '#B1ADFD', '#B9B5FD', '#C0BDFD', '#C8C5FD', '#D0CDFD']
      }
      const hbarData = sortGroups(groupBy(data, 'LanguageWorkedWith', (value) => {
        return value / data.length;
      }), true);
      hbar.plot(hbarData, hbarOptions);

      // Plot histogram
      const hist = new Hist(d3);
      const histOptions = {
        container: '#hist-chart-container',
        width: 750,
        height: 225,
        margin: { top: 20, right: 30, bottom: 20, left: 40 },
        padding: 0.1,
        bins: 20
      }
      const histData = values(data, 'ConvertedSalary');
      hist.plot(histData, histOptions);

      filter.onFilterApplied(data => {
        updateDashboardTitle(data.length);
        hbar.updateData(sortGroups(groupBy(data, 'LanguageWorkedWith', (value) => {
          return value / data.length;
        }), true));
      });
      toggleSpinner();
    });
  </script>
</html>
